# Del MER al model relacional

- M0484 – Bases de dades
- Del diagrama (MER) a les taules

Note:
- Objectiu de la sessió: que siguin capaços d'agafar un MER senzill i treure'n les taules.
- Insisteix: **encara no fem SQL**, només disseny de taules (model lògic).
- Explica que després, un altre dia, aquest model relacional el passarem a `CREATE TABLE`.

---

## Recordatori ràpid: què hi ha en un MER?

- **Entitats** (caixes)
- **Atributs** (el·lipses)
- **Relacions** (rombes)
- **Cardinalitats**: 1, N, (0,N), (1,1)...

Note:
- Aquí pots obrir un MER qualsevol de classe.
- Pregunta:
  - “Algú em diu una entitat del diagrama?”
  - “Quina informació guardem d'aquesta entitat (atributs)?”
  - “On veieu les relacions?”

----

![../../../assets/img/0484-bases-de-dades/agencia-viatges-mer.png](../../../assets/img/0484-bases-de-dades/agencia-viatges-mer.png)

---

## On volem arribar?

Volem transformar el MER en **taules**:

- Cada taula tindrà:
  - Nom de la taula
  - Llista de camps
  - **Clau primària (***PK***)**
  - **Claus foranes (***FK***)** quan calgui

Note:
- Explica que això és el **model relacional**.
- Escriu a la pissarra un exemple de taula simple (p.ex. CLIENTS(id_client, nom, email)).

---

## Regles generals (resum)
|Regla|Situació|Dosseny|
|----|-----|-----|
|1.|**Entitat forta**|**1 taula**|
|2.|**Entitat feble**|**1 taula** (***PK*** acostuma a ser composta)|
|3.|**Relació <kbd style="padding:5px; background-color:lightgrey; color:blue">1:N</kbd>** sense atributs|***FK*** al costat de la **N**|
|4.|**Relació <kbd style="padding:5px; background-color:lightgrey; color:blue">1:N</kbd>** amb atributs|***FK*** i camps al costat de la **N**|
|5.|**Relació <kbd style="padding:5px; background-color:lightgrey; color:blue">1:1</kbd>**|***FK*** a una de les dues taules**|
|6.|**Relació **N:M****|**nova taula** (taula intermitja)|

Note:
- Digues que avui veureu **cada punt amb un exemple** + fitxer `.xml` perquè ho vegin clar a la pantalla.
- Explica que després de cada exemple farem la taula corresponent.

---

## 1) Entitat forta

- Existeix per si sola.
- Té una ***PK*** pròpia que la identifica.

**Exemples típics**
- <kbd style="padding:5px; background-color:lightgrey; color:blue">CLIENTS</kbd>, <kbd style="padding:5px; background-color:lightgrey; color:blue">PRODUCTE</kbd>, <kbd style="padding:5px; background-color:lightgrey; color:blue">PROVEÏDOR</kbd>, <kbd style="padding:5px; background-color:lightgrey; color:blue">EQUIP</kbd>, <kbd style="padding:5px; background-color:lightgrey; color:blue">CAMP</kbd>…

Note:
- Obre el fitxer `exemple-entitat-forta-client.xml` a diagrams.net.
- Pregunta:
  - “Quina és l'entitat?”
  - “Quin atribut és la clau primària?”
- Escriu a la pissarra (o en una diapositiva nova):


----

<kbd style="padding:5px; background-color:lightgrey; color:blue">CLIENTS(**<u>id_client</u>** ***PK***, nom_client, email_client)</kbd>

<img src="../../../assets/img/0484-bases-de-dades/entitat-forta.png" alt="0484-bases-de-dades/entitat-forta.png" class="logo" height="200" width="auto">

----

## 1a Regla

### una <u>Entitat forta</u> passa a ser una <u>Taula</u>


- Entitat forta **→ 1 taula amb el mateix nom**.
- Atribut clau subratllat al MER → ***PK*** de la taula.

----

**Exemple**

Del MER de **`CLIENTS`**:

- **MER**: ***entitat*** **`CLIENTS`** <br> amb ***atributs*** <u>**`id_client`**</u>, **`nom_client`**, **`email_client`**.

<img src="../../../assets/img/0484-bases-de-dades/entitat-forta.png" alt="0484-bases-de-dades/entitat-forta.png" class="logo" height="200" width="auto">

- **Taula**: <kbd style="padding:5px; background-color:lightgrey; color:blue">CLIENTS(**<u>id_client</u>** ***PK***, nom_client, email_client)</kbd>

Note:
- Torna a mostrar el diagrama de l'exemple i que ells dictin la taula.
- Pots fer-los escriure la taula al quadern.




---

## 2) Entitat feble

- No s'identifica sola.
- Depèn d'una altra entitat (forta).
- La seva ***PK*** sol incloure la ***PK*** de l'**entitat forta**.

**Exemple**

- <kbd style="padding:5px; background-color:lightgrey; color:blue">COMANDES</kbd> => Entitat forta

- <kbd style="padding:5px; background-color:lightgrey; color:blue">LINIES_COMANDA</kbd>  => Entitat feble – Cada **línia** depèn d'una **comanda**.

<img src="../../../assets/img/0484-bases-de-dades/entitat-feble.png" alt="0484-bases-de-dades/entitat-feble.png" class="logo" height="200" width="auto">


Note:
- Obre `exemple-entitat-feble-comanda-linia.xml`.
- Pregunta:
  - “Podem identificar una línia de comanda sense saber de quina comanda és?”

----

## 2a Regla

### una <u>Entitat feble</u> passa a ser una <u>Taula</u>

- Entitat feble → taula amb ***PK*** composta:
  - una part de la ***PK*** és la <u>pròpia</u>, i
  - una part de la ***PK*** ve de l'**entitat forta**,

- La ***PK*** de l'entitat forta es marca també com a ***FK***.


Note:
- Repassa l'exemple de LINIES_COMANDA:

  - **`id_comanda`** forma part de la ***PK*** i és alhora ***FK*** → COMANDES.
- Subratlla que això apareixerà molt en casos de “línies” (factures, comandes…).


----

<img src="../../../assets/img/0484-bases-de-dades/entitat-feble-colors.png" alt="0484-bases-de-dades/entitat-feble-colors.png" class="logo" height="200" width="auto">


* <kbd style="padding:5px; background-color:lightgrey; color:blue">COMANDES(**<u>id_comanda</u>** ***PK***, data_comanda)</kbd>

* <kbd style="padding:5px; background-color:lightgrey; color:blue">LINIES_COMANDA(<u>**num_linia**</u> ***PK***, **<u>id_comanda</u>** ***PK*** i ***FK*** <small>(**PK** de COMANDES)</small>, producte, quantitat)</kbd>


---

## 3) Relació <kbd style="padding:5px; background-color:lightgrey; color:blue">1:N</kbd> (sense atributs)

- Un **registre** de l'**entitat A** <u>pot tenir</u> **molts registres** de l'**entitat B**.

- Un **registre** de l'**entitat B** <u>pertany</u> **a un sol registre** de l'**entitat A**

<img src="../../../assets/img/0484-bases-de-dades/relacio-1N-client-comanda.png" alt="0484-bases-de-dades/relacio-1N-client-comanda.png" class="logo" height="150" width="auto">

Note:
- Obre `exemple-relacio-1N-client-comanda.xml`.
- Demana que llegeixin la cardinalitat (1,N).

----

## 3a Regla

### una <u>Relació</u> <kbd style="padding:5px; background-color:lightgrey; color:blue">1:N</kbd> <u>sense atributs propis</u>

* Es posa una ***FK*** a la taula del costat on hi ha **N**.

* **Exemple CLIENT–COMANDA**

<img src="../../../assets/img/0484-bases-de-dades/relacio-1N-client-comanda.png" alt="0484-bases-de-dades/relacio-1N-client-comanda.png" class="logo" height="150" width="auto">

----

<img src="../../../assets/img/0484-bases-de-dades/relacio-1N-client-comanda.png" alt="0484-bases-de-dades/relacio-1N-client-comanda.png" class="logo" height="150" width="auto">

#### Taules resultants:

* <kbd style="padding:5px; background-color:lightgrey; color:blue">CLIENTS(**<u>id_client</u>** ***PK***, nom_client, email_client)</kbd>

* <kbd style="padding:5px; background-color:lightgrey; color:blue">COMANDES(**<u>id_comanda</u>** ***PK***, **<u>id_client</u>** ***PK***, data_comanda)</kbd>

Note:
- Demana: “On afegiríeu el camp id_client?”
- Fes-los veure que si poséssim la ***FK*** al costat 1 (CLIENTS) seria un desastre (molts camps **`id_comanda`**, etc.).

---

## 4) Relació <kbd style="padding:5px; background-color:lightgrey; color:blue">1:N</kbd> **amb atributs**

- Un **registre** de l'**entitat A** <u>pot tenir</u> **molts registres** de l'**entitat B**.

- Un **registre** de l'**entitat B** <u>pertany</u> **a un sol registre** de l'**entitat A**

- La relació del **registre** de l'**entitat B** <u>amb</u> **el registre** de l'**entitat A**, conté **atributs**.

<img src="../../../assets/img/0484-bases-de-dades/relacio-1N-amb-atributs-client-comanda.png" alt="0484-bases-de-dades/relacio-1N-amb-atributs-client-comanda.png" class="logo" height="200" width="auto">

Note:
- Obre el fitxer `exemple-relacio-1N-amb-atributs-client-comanda.xml`.
- Demana:
  - “Aquest ‘descompte’ pertany al CLIENT, a la COMANDA o al vincle FA?”
- Guia’ls a la idea: és un descompte **d’aquesta comanda concreta**.

----

## 4a Regla

- Es posa una ***FK***, i **TOTS els atributs de la relació** a la taula del costat on hi ha **N**.

- Relació <kbd style="padding:5px; background-color:lightgrey; color:blue">1:N</kbd> amb atributs:
  - FK al costat N.
  - Atributs de la relació → també a la taula del costat N.

<img src="../../../assets/img/0484-bases-de-dades/relacio-1N-amb-atributs-client-comanda.png" alt="0484-bases-de-dades/relacio-1N-amb-atributs-client-comanda.png" class="logo" height="200" width="auto">

----

<img src="../../../assets/img/0484-bases-de-dades/relacio-1N-amb-atributs-client-comanda.png" alt="0484-bases-de-dades/relacio-1N-amb-atributs-client-comanda.png" class="logo" height="200" width="auto">

#### Taules resultants:

* <kbd style="padding:5px; background-color:lightgrey; color:blue">CLIENTS(**<u>id_client</u>** ***PK***, nom_client, email_client)</kbd>

* <kbd style="padding:5px; background-color:lightgrey; color:blue">COMANDES(**<u>id_comanda</u>** ***PK***, **<u>id_client</u>** ***PK*** i ***FK*** <small>(**PK** de COMANDES)</small>, data_comanda, descompte)</kbd>

Note:
- Escriu les taules a la pissarra i que les copiïn.
- Pregunta: “Si fos **N:M** en lloc de <kbd style="padding:5px; background-color:lightgrey; color:blue">1:N</kbd>, què hauríem de fer amb descompte?”
  → resposta: crear una taula nova (p.ex. DETALL_COMANDA) amb id_client, id_comanda i descompte.

---

## 5) Relació <kbd style="padding:5px; background-color:lightgrey; color:blue">1:1</kbd>

- Un **registre** de l'**entitat A** <u>va amb</u> **un sol registre** de l'**entitat B**.

- Un **registre** de l'**entitat B** <u>va amb</u> **un sol registre** de l'**entitat A**.

<img src="../../../assets/img/0484-bases-de-dades/relacio-11-persona-passaport.png" alt="0484-bases-de-dades/relacio-11-persona-passaport.png" class="logo" height="150" width="auto">

Note:
- Obre `exemple-relacio-11-persona-passaport.xml`.
- Pregunta:
  - “Què passaria si una persona pogués tenir més d'un passaport? La cardinalitat canviaria.”

----

## 5a Regla

**Regla bàsica**

- Escollim **una** de les dues taules i hi afegim la ***FK***.

- Alternativa: **fusionar** les dues entitats en una sola taula (si té sentit).

<img src="../../../assets/img/0484-bases-de-dades/relacio-11-persona-passaport.png" alt="0484-bases-de-dades/relacio-11-persona-passaport.png" class="logo" height="150" width="auto">


----

<img src="../../../assets/img/0484-bases-de-dades/relacio-11-persona-passaport.png" alt="0484-bases-de-dades/relacio-11-persona-passaport.png" class="logo" height="150" width="auto">

#### Taules resultants:

* <kbd style="padding:5px; background-color:lightgrey; color:blue">PERSONES(**<u>id_persona</u>** ***PK***, nom_persona, data_naixement)</kbd>

* <kbd style="padding:5px; background-color:lightgrey; color:blue">PASSAPORTS(**<u>num_passaport</u>** ***PK***, **<u>id_persona</u>** ***PK***, data_caducitat)</kbd>

Note:
- Explica que la tria depèn de:
  - Quina entitat és “principal”.
  - Si sempre hi ha passaport o pot no existir (***FK*** nullable).
- No cal entrar en massa casuística; només que entenguin la idea.

---

## 6) Relació **N:M**

- Molts **registres** de l'**entitat A** <u>es relacionen amb</u> **molts registres** de l'**entitat B**.

- Molts **registres** de l'**entitat B** <u>es relacionen amb</u> **molts registres** de l'**entitat A**.

<img src="../../../assets/img/0484-bases-de-dades/relacio-NM-alumne-assignatura.png" alt="0484-bases-de-dades/relacio-NM-alumne-assignatura.png" class="logo" height="200" width="auto">

Note:
- Obre `exemple-relacio-NM-alumne-assignatura.xml`.
- Demana:
  - “Pot un alumne estar en moltes assignatures?”
  - “Pot una assignatura tenir molts alumnes?”

----

## 6a Regla

- Relació **N:M** sempre es converteix en **nova taula**.
- La nova taula conté:
  - ***FK*** → A
  - ***FK*** → B
  - Sovint la ***PK*** és (***FK_A***, ***FK_B***).


----

**Exemple ALUMNE–ASSIGNATURA**

* <kbd style="padding:5px; background-color:lightgrey; color:blue">ALUMNES(**<u>id_alumne</u>** ***PK***, nom_alumne, ...)</kbd>

* <kbd style="padding:5px; background-color:lightgrey; color:blue">ASSIGNATURES(**<u>id_assig</u>** ***PK***, nom_assig, ...)</kbd>

* <kbd style="padding:5px; background-color:lightgrey; color:blue">MATRICULES(**<u>id_alumne</u>** ***PK*** i ***FK*** <small>(**PK** de ALUMNES)</small>, **<u>id_assig</u>** ***PK*** i ***FK*** <small>(**PK** de ASSIGNATURES)</small>, nota)</kbd>

<img src="../../../assets/img/0484-bases-de-dades/relacio-NM-alumne-assignatura.png" alt="0484-bases-de-dades/relacio-NM-alumne-assignatura.png" class="logo" height="200" width="auto">

Note:
- Subratlla que la relació “MATRICULA” es converteix en una taula normal.
- Si hi ha **atributs de la relació** (data, nota), aquests viuen a la taula MATRICULES.

---

## Resum final

|Regla|Situació|Dosseny|
|----|-----|-----|
|1.|**Entitat forta**|**1 taula**|
|2.|**Entitat feble**|**1 taula** (***PK*** acostuma a ser composta)|
|3.|**Relació <kbd style="padding:5px; background-color:lightgrey; color:blue">1:N</kbd>** sense atributs|***FK*** al costat de la **N**|
|4.|**Relació <kbd style="padding:5px; background-color:lightgrey; color:blue">1:N</kbd>** amb atributs|***FK*** i camps al costat de la **N**|
|5.|**Relació <kbd style="padding:5px; background-color:lightgrey; color:blue">1:1</kbd>**|***FK*** a una de les dues taules**|
|6.|**Relació **N:M****|**nova taula** (taula intermitja)|

Note:
- Torna a les regles generals i repassa-les ràpid.
- Deixa clar que ara toca **pràctica**.

---

## Activitat de classe

En grups de 2–3:

1. Us dono un MER (p.ex. CLIENT–COMANDA–PRODUCTE).
2. Heu de:
   - Llistar les entitats i les relacions.
   - Escriure les taules (amb ***PK*** i ***FK***).
3. Després ho corregim a la pissarra.

Note:
- Pots reutilitzar l'exemple CLIENT–COMANDA–PRODUCTE que ja teniu.
- Mentre treballen, passa per les taules i mira on s'encallen:
  - Saben on va la ***FK*** en <kbd style="padding:5px; background-color:lightgrey; color:blue">1:N</kbd>?
  - Saben crear la taula de **N:M**?
   
