# Propostes de millora de seguretat i integritat de dades

## Base de dades Escape Rooms

### 0484 â€“ Bases de dades

---

## Punt de partida

Ja tenim una base de dades que:

- reflecteix correctament el domini del problema
- tÃ© totes les taules necessÃ ries
- utilitza claus primÃ ries i foranes

â¬‡ï¸

----

PerÃ²...

**Una BD correcta no sempre Ã©s una BD segura**

Encara permet:

- dades duplicades
- incoherÃ¨ncies
- errors humans en els `INSERT`

---

## Objectiu dâ€™aquesta millora

Fer que la base de dades:

- **eviti errors automÃ ticament**
- **sigui mÃ©s robusta**
- **garanteixi la integritat de les dades**

Sense canviar el model,  
**afegint restriccions i normes**.

---

## Tipus de millores que veurem

Treballarem amb:

1. Restriccions `UNIQUE`
2. Claus compostes per evitar duplicats lÃ²gics
3. Restriccions `CHECK`
4. ProtecciÃ³ de relacions amb  
   `ON DELETE` i `ON UPDATE`

---

## 1. Restriccions UNIQUE  

### Evitar duplicats reals

Les claus primÃ ries eviten duplicats dâ€™ID,  
perÃ² **no eviten duplicats lÃ²gics**.

â¬‡ï¸

----

Exemple de problema:

- dues seus amb el mateix nom
- dues sales iguals dins la mateixa seu
- dos equips amb el mateix nom

*  **La BD ho permet... si no fem res**

---

## UNIQUE a la taula SEUS

No hauria dâ€™existir:

- la mateixa seu
- a la mateixa ciutat
- repetida

â¬‡ï¸

----

```sql
ALTER TABLE SEUS
ADD CONSTRAINT uq_seu_nom_ciutat
UNIQUE (nom_seu, ciutat_seu);
```

* Evita seus duplicades de manera automÃ tica.

---

## UNIQUE a la taula SALES

Dins dâ€™una mateixa seu:

- no pot haver-hi dues sales amb el mateix nom

â¬‡ï¸

----

```sql
ALTER TABLE SALES
ADD CONSTRAINT uq_sala_seu
UNIQUE (nom_sala, id_seu);
```

---

## UNIQUE a la taula EQUIPS

Els equips es poden reutilitzar en reserves.

*  El nom ha de ser Ãºnic.

â¬‡ï¸

----

```sql
ALTER TABLE EQUIPS
ADD CONSTRAINT uq_nom_equip
UNIQUE (nom_equip);
```

---

## 2. Evitar duplicats lÃ²gics  
### Cas de les reserves

Una situaciÃ³ problemÃ tica:

- mateixa sala
- mateixa data i hora
- dues reserves diferents

âŒ Impossible en la realitat  
* Possible a la BD (si no ho evitem)

---

## UNIQUE a RESERVES

â¬‡ï¸

```sql
ALTER TABLE RESERVES
ADD CONSTRAINT uq_reserva_sala_data
UNIQUE (id_sala, data_hora);
```

* Garanteix que una sala  
no pot tenir dues reserves simultÃ nies.

---

## 3. Restriccions CHECK  
### Validar dades absurdes

Alguns errors tÃ­pics:

- durades negatives
- puntuacions negatives
- reserves amb 0 participants

*  **La BD no hauria dâ€™acceptar aixÃ²**

---

## CHECK a SALES

â¬‡ï¸

```sql
ALTER TABLE SALES
ADD CONSTRAINT chk_durada_sala
CHECK (durada_max_sala > 0),
ADD CONSTRAINT chk_max_participants
CHECK (max_participants_sala > 0);
```

---

## CHECK a RESERVES i RESULTATS

â¬‡ï¸

```sql
ALTER TABLE RESERVES
ADD CONSTRAINT chk_num_participants
CHECK (num_participants > 0);
```

```sql
ALTER TABLE RESULTATS
ADD CONSTRAINT chk_puntuacio
CHECK (puntuacio >= 0);
```

* La BD bloqueja dades incoherents.

---

## 4. Protegir relacions  
### ON DELETE / ON UPDATE

Abans de veure el SQL, una mica de teoria ğŸ‘‡

---

## QuÃ¨ passa quan sâ€™elimina una fila?

Si una taula estÃ  relacionada amb una altra:

- QuÃ¨ passa si sâ€™elimina el registre pare?
- I si sâ€™actualitza la seva clau?

*  **La BD ha de saber quÃ¨ fer**

---

## Opcions principals

Quan definim una clau forana, podem indicar:

- `ON DELETE`
- `ON UPDATE`

Amb diferents comportaments:

- `RESTRICT`
- `CASCADE`
- `SET NULL`

---

## ON DELETE RESTRICT

No permet eliminar el registre pare  
-> si tÃ© registres fills associats.

* Exemple:

- no es pot eliminar una seu si tÃ© sales

Ã‰s una opciÃ³ **molt segura**.

---

## ON DELETE CASCADE

En eliminar el registre pare:

- sâ€™eliminen automÃ ticament els fills

* Exemple:

- eliminar un equip
- elimina les relacions amb participants

Cal usar-ho amb criteri.

---

## ON UPDATE CASCADE

Si canvia la clau primÃ ria del pare:

- sâ€™actualitza automÃ ticament a les filles

* Molt Ãºtil
* Poques vegades perillÃ³s

---

## Exemple aplicat: SALES â†’ SEUS

â¬‡ï¸

```sql
ALTER TABLE SALES
ADD CONSTRAINT fk_sales_seus
FOREIGN KEY (id_seu)
REFERENCES SEUS(id_seu)
ON DELETE RESTRICT
ON UPDATE CASCADE;
```

* No es poden eliminar seus amb sales
* Els canvis dâ€™ID es propaguen

---

## Exemple aplicat: EQUIP_PARTICIPANT â†’ EQUIPS

â¬‡ï¸

```sql
ALTER TABLE EQUIPS
ADD CONSTRAINT fk_id_equip
FOREIGN KEY (id_equip)
REFERENCES EQUIPS(id_equip)
ON DELETE CASCADE;
```

* Si sâ€™elimina un equip  
* desapareixen les seves relacions

---

## Missatge clau

> Una bona base de dades  
> **no confia en lâ€™usuari**.

â¬‡ï¸

----

La seguretat i la coherÃ¨ncia:

- no depenen dels `INSERT`
- depenen del **disseny**

---

## Resum final

Amb aquestes millores:

- * evitem duplicats
- * evitem incoherÃ¨ncies
- * la BD es protegeix sola

