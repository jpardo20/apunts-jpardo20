# Propostes de millora de seguretat i integritat de dades

## Base de dades Escape Rooms

### 0484 – Bases de dades

---

## Punt de partida

Ja tenim una base de dades que:

- reflecteix correctament el domini del problema
- té totes les taules necessàries
- utilitza claus primàries i foranes

⬇️

----

Però...

**Una BD correcta no sempre és una BD segura**

Encara permet:

- dades duplicades
- incoherències
- errors humans en els <codijpc>INSERT/codijpc>

---

## Objectiu d’aquesta millora

Fer que la base de dades:

- **eviti errors automàticament**
- **sigui més robusta**
- **garanteixi la integritat de les dades**

Sense canviar el model,  
**afegint restriccions i normes**.

---

## Tipus de millores que veurem

Treballarem amb:

1. Restriccions `UNIQUE`
2. Claus compostes per evitar duplicats lògics
3. Restriccions `CHECK`
4. Protecció de relacions amb  
   <codijpc>ON DELETE</codijpc> i <codijpc>ON UPDATE</codijpc>

---

## 1. Restriccions UNIQUE  

### Evitar duplicats reals

Les claus primàries eviten duplicats d’ID,  
però **no eviten duplicats lògics**.

⬇️

----

Exemple de problema:

- dues seus amb el mateix nom
- dues sales iguals dins la mateixa seu
- dos equips amb el mateix nom

<br>
<br>
<br>

###  **La BD ho permet... si no fem res**

---

## UNIQUE a la taula SEUS

No hauria d’existir:

- la mateixa seu
- a la mateixa ciutat
- repetida

⬇️

----

```sql
ALTER TABLE SEUS
ADD CONSTRAINT uq_seu_nom_ciutat
UNIQUE (nom_seu, ciutat_seu);
```

* Evita seus duplicades de manera automàtica.

---

## UNIQUE a la taula SALES

Dins d’una mateixa seu:

- no pot haver-hi dues sales amb el mateix nom

⬇️

----

```sql
ALTER TABLE SALES
ADD CONSTRAINT uq_sala_seu
UNIQUE (nom_sala, id_seu);
```

---

## UNIQUE a la taula EQUIPS

Els equips es poden reutilitzar en reserves.


<br>
<br>
<br>

### El nom ha de ser únic.

⬇️

----

```sql
ALTER TABLE EQUIPS
ADD CONSTRAINT uq_nom_equip
UNIQUE (nom_equip);
```

---

## 2. Evitar duplicats lògics  
### Cas de les reserves

Una situació problemàtica:

- mateixa sala
- mateixa data i hora
- dues reserves diferents

❌ Impossible en la realitat  

<br>
<br>
<br>

###  Possible a la BD (si no ho evitem)

---

## UNIQUE a RESERVES

```sql
ALTER TABLE RESERVES
ADD CONSTRAINT uq_reserva_sala_data
UNIQUE (id_sala, data_hora);
```

<br>
<br>
<br>

### Garanteix que una sala  
### no pot tenir dues reserves simultànies.

---

## 3. Restriccions CHECK  
### Validar dades absurdes

Alguns errors típics:

- durades negatives
- puntuacions negatives
- reserves amb 0 participants

<br>
<br>
<br>

### **La BD no hauria d’acceptar això**

---

## CHECK a SALES

```sql
ALTER TABLE SALES
ADD CONSTRAINT chk_durada_sala
CHECK (durada_max_sala > 0),
ADD CONSTRAINT chk_max_participants
CHECK (max_participants_sala > 0);
```

> Per comprovar que el CHECK ha estat afegit correctament a la taula ...

⬇️

----

## Per comprovar que el CHECK ha estat afegit correctament a la taula <codijpc>SALES/codijpc> podem executar la següent comanda <codijpc>show create table SALES;</codijpc>:


```sql
MariaDB [escape_room]> show create table SALES;
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| SALES | CREATE TABLE `SALES` (
  `id_sala` int(11) NOT NULL AUTO_INCREMENT,
  `nom_sala` varchar(100) DEFAULT NULL,
  `tematica` varchar(50) DEFAULT NULL,
  `dificultat` enum('Fàcil','Mitjà','Difícil') NOT NULL,
  `durada_max` int(11) DEFAULT NULL,
  `max_parti` int(11) DEFAULT NULL,
  `id_seu` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_sala`),
  UNIQUE KEY `uq_sala_seu` (`nom_sala`,`id_seu`),
  KEY `fk_sales_seus` (`id_seu`),
  CONSTRAINT `SALES_ibfk_1` FOREIGN KEY (`id_seu`) REFERENCES `SEUS` (`id_seu`),
  CONSTRAINT `fk_sales_seus` FOREIGN KEY (`id_seu`) REFERENCES `SEUS` (`id_seu`) ON UPDATE CASCADE,
  CONSTRAINT `chk_durada_sala` CHECK (`durada_max` > 0),
  CONSTRAINT `chk_max_participants` CHECK (`max_parti` > 0)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci    |
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.000 sec)

MariaDB [escape_room]>

```

---

## CHECK a RESERVES i RESULTATS

```sql
ALTER TABLE RESERVES
ADD CONSTRAINT chk_num_participants
CHECK (num_participants > 0);
```

```sql
ALTER TABLE RESULTATS
ADD CONSTRAINT chk_puntuacio
CHECK (puntuacio >= 0);
```

<br>
<br>
<br>

### La BD bloqueja dades incoherents.

> Per comprovar que el CHECK ha estat afegit correctament a la taula ...

⬇️

----

## Per comprovar que el CHECK ha estat afegit correctament a la taula <codijpc>RESERVES/codijpc> podem executar la següent comanda <codijpc>show create table RESERVES;</codijpc>:

```sql
MariaDB [escape_room]> show create table RESERVES;
+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table    | Create Table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| RESERVES | CREATE TABLE `RESERVES` (
  `id_reserva` int(11) NOT NULL AUTO_INCREMENT,
  `data_hora_reserva` datetime DEFAULT NULL,
  `estat_reserva` enum('Realitzada','Cancel·lada','Pendent') NOT NULL,
  `qtat_participants` int(11) DEFAULT NULL,
  `id_sala` int(11) DEFAULT NULL,
  `id_equip` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_reserva`),
  UNIQUE KEY `uq_reserva_sala_data` (`id_sala`,`data_hora_reserva`),
  KEY `id_equip` (`id_equip`),
  CONSTRAINT `RESERVES_ibfk_1` FOREIGN KEY (`id_sala`) REFERENCES `SALES` (`id_sala`),
  CONSTRAINT `RESERVES_ibfk_2` FOREIGN KEY (`id_equip`) REFERENCES `EQUIPS` (`id_equip`),
  CONSTRAINT `chk_num_participants` CHECK (`qtat_participants` > 0)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci  |
+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.001 sec)

MariaDB [escape_room]>

```

> Per comprovar que el CHECK ha estat afegit correctament a la taula ...

⬇️

----

## Per comprovar que el CHECK ha estat afegit correctament a la taula **`RESULTATS`** podem executar la següent comanda <codijpc>show create table RESULTATS;</codijpc>:

```sql
MariaDB [escape_room]> show create table RESULTATS;
+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table     | Create Table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| RESULTATS | CREATE TABLE `RESULTATS` (
  `id_resultat` int(11) NOT NULL AUTO_INCREMENT,
  `temps_utilitzat` int(11) DEFAULT NULL,
  `exit_fracas` tinyint(1) DEFAULT NULL,
  `puntuacio` int(11) DEFAULT NULL,
  `qtat_pistes` int(11) DEFAULT NULL,
  `id_reserva` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_resultat`),
  KEY `id_reserva` (`id_reserva`),
  CONSTRAINT `RESULTATS_ibfk_1` FOREIGN KEY (`id_reserva`) REFERENCES `RESERVES` (`id_reserva`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci |
+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.000 sec)

MariaDB [escape_room]>

```

---

## 4. Protegir relacions  
### ON DELETE / ON UPDATE

Abans de veure el SQL, una mica de teoria

---

## Què passa quan s’elimina una fila?

Si una taula està relacionada amb una altra:

- Què passa si s’elimina el registre pare?
- I si s’actualitza la seva clau?


<br>
<br>
<br>

###  **La BD ha de saber què fer**

---

## Opcions principals

Quan definim una clau forana, podem indicar:

- <codijpc>ON DELETE</codijpc>
- <codijpc>ON UPDATE</codijpc>

Amb diferents comportaments:

- <codijpc>RESTRICT</codijpc>
- <codijpc>CASCADE</codijpc>
- <codijpc>SET NULL</codijpc>

---

## ON DELETE RESTRICT

No permet eliminar el registre pare  
-> si té registres fills associats.

* Exemple:

- no es pot eliminar una seu si té sales

És una opció **molt segura**.

---

## ON DELETE CASCADE

En eliminar el registre pare:

- s’eliminen automàticament els fills

* Exemple:

- eliminar un equip
- elimina les relacions amb participants

Cal usar-ho amb criteri.

---

## ON UPDATE CASCADE

Si canvia la clau primària del pare:

- s’actualitza automàticament a les filles

* Molt útil
* Poques vegades perillós

---

## Exemple aplicat: SALES → SEUS


```sql
ALTER TABLE SALES
ADD CONSTRAINT fk_sales_seus
FOREIGN KEY (id_seu)
REFERENCES SEUS(id_seu)
ON DELETE RESTRICT
ON UPDATE CASCADE;
```

* No es poden eliminar seus amb sales
* Els canvis d’ID es propaguen

---

## Exemple aplicat: EQUIP_PARTICIPANT → EQUIPS


```sql
ALTER TABLE EQUIPS
ADD CONSTRAINT fk_id_equip
FOREIGN KEY (id_equip)
REFERENCES EQUIPS(id_equip)
ON DELETE CASCADE;
```

* Si s’elimina un equip  
* desapareixen les seves relacions

---

## Missatge clau

> Una bona base de dades  
> **no confia en l’usuari**.

⬇️

----

La seguretat i la coherència:

- no depenen dels <codijpc>INSERT/codijpc>
- depenen del **disseny**

---

## Resum final

Amb aquestes millores:

- * evitem duplicats
- * evitem incoherències
- * la BD es protegeix sola

